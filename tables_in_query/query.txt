SELECT  t.item,
        t.item_desc,
        t.store_name,
        t.adjust_date,
        t.employee_id,
        t.comment_desc,
        --t.gor_no,
        t.store,
        t.adjust_qty,
        t.order_qty,
        t.gor_qty,
        t.ORDER_NO
FROM
        (SELECT i.item ,
                i.item_desc
                --    ,NVL(ish.item_desc, i.item_desc) item_desc
                ,
                TO_CHAR(s.store)
                || ' '
                || s.store_name store_name ,
                TO_CHAR(a.tran_date, 'DD-MM-YYYY') adjust_date ,
                b.employee_id ,
                b.comment_desc
                /*,NVL((
                SELECT SUBSTR(gor, 5, 6)
                FROM sim132.GOR_DSD_RTV
                --  WHERE order_id = TO_CHAR(a.ref_no_1)
                WHERE order_id = TO_CHAR(b.order_id)
                ), (
                SELECT SUBSTR(gor, 5, 6)
                FROM sim132.GOR_DSD_RTV
                WHERE order_id = TO_CHAR(a.ref_no_1)
                )) gor_no */
                ,
                s.store ,
                a.units adjust_qty ,
                c.quantity_expected order_qty ,
                c.quantity_received gor_qty ,
                b.order_id ORDER_NO
        FROM    tran_data@SIM_LINKRMSDB a ,
                shipment@SIM_LINKRMSDB shp ,
                SIM132.rk_shipments b ,
                store@SIM_LINKRMSDB s ,
                item_master@SIM_LINKRMSDB i ,
                SIM132.RK_SHIPMENT_ITEM c
                --    ,(
                --        SELECT ish.item
                --            ,ish.item_desc
                --        FROM mv_item_shadow ish
                --            ,user_attrib_bi b
                --        WHERE ish.lang = b.lang
                --            AND b.user_id = upper(:xdo_user_name)
                --        ) ish
        WHERE   a.tran_code        = 20
            AND a.adj_code         = 'U'
            AND TRUNC(a.tran_date) = :PM_DATE
            AND b.order_id         = NVL(:PM_ORDER, b.order_id)
            AND s.store           IN (:PM_LOC)
            AND ( b.shipment_id    = shp.ext_ref_no_in
             OR 'SIM.'
                || b.shipment_id = shp.ASN )
            AND shp.order_no     = ref_no_1
            AND b.store_id       = a.location
            AND s.store          = a.location
            AND ( i.item         = a.item
             OR i.item           = a.ref_pack_no )
                --    AND i.item = ish.item(+)
            AND b.shipment_id   = c.shipment_id
            AND i.item          = c.item_id
            AND LEAST(:PM_LOC) IS NOT NULL
            AND :PM_DATE       IS NOT NULL
        UNION
        SELECT  i.item ,
                i.item_desc
                --    ,NVL(ish.item_desc, i.item_desc) item_desc
                ,
                TO_CHAR(s.store)
                || ' '
                || s.store_name store_name ,
                TO_CHAR(a.tran_date, 'DD-MM-YYYY') adjust_date ,
                b.employee_id ,
                b.comment_desc
                /*,NVL((
                SELECT SUBSTR(gor, 5, 6)
                FROM sim132.GOR_DSD_RTV
                --  WHERE order_id = TO_CHAR(a.ref_no_1)
                WHERE order_id = TO_CHAR(b.order_id)
                ), (
                SELECT SUBSTR(gor, 5, 6)
                FROM sim132.GOR_DSD_RTV
                WHERE order_id = TO_CHAR(a.ref_no_1)
                )) gor_no*/
                ,
                s.store ,
                a.units adjust_qty ,
                c.quantity_expected order_qty ,
                c.quantity_received gor_qty ,
                b.order_id ORDER_NO
        FROM    tran_data_history@SIM_LINKRMSDB a ,
                shipment@SIM_LINKRMSDB shp ,
                SIM132.rk_shipments b ,
                store@SIM_LINKRMSDB s ,
                item_master@SIM_LINKRMSDB i ,
                SIM132.RK_SHIPMENT_ITEM c
                --    ,(
                --        SELECT ish.item
                --            ,ish.item_desc
                --        FROM mv_item_shadow ish
                --            ,user_attrib_bi b
                --        WHERE ish.lang = b.lang
                --            AND b.user_id = upper(:xdo_user_name)
                --        ) ish
        WHERE   a.tran_code        = 20
            AND a.adj_code         = 'U'
            AND TRUNC(a.tran_date) = :PM_DATE
            AND b.order_id         = NVL(:PM_ORDER, b.order_id)
            AND s.store           IN (:PM_LOC)
            AND ( b.shipment_id    = shp.ext_ref_no_in
             OR 'SIM.'
                || b.shipment_id = shp.ASN )
            AND shp.order_no     = ref_no_1
            AND b.store_id       = a.location
            AND s.store          = a.location
            AND ( i.item         = a.item
             OR i.item           = a.ref_pack_no )
                --    AND i.item = ish.item(+)
            AND b.shipment_id   = c.shipment_id
            AND i.item          = c.item_id
            AND LEAST(:PM_LOC) IS NOT NULL
            AND :PM_DATE       IS NOT NULL
        ) t
ORDER BY order_no ,
        item;